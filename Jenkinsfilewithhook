node {
 properties([
  pipelineTriggers([
   [$class: 'GenericTrigger',
    genericVariables: [
     [ key: 'committer_name', value: '$.pusher.name' ],
     [ key: 'committer_email', value: '$.commits.committer.email' ],
     [ key: 'commit', value: '$.commits.message' ],
     [ key: 'clone_url', value: '$.html_url' ]
    ],
     
    causeString: '$committer_name pushed to $clone_url referencing $commit',
    
    token: 'abc123',
    
    printContributedVariables: true,
    printPostContent: true,
    

   ]
  ])
 ])

 stage("Prepare") {
  deleteDir()
  sh '''
  echo git clone $clone_url
  echo git checkout $commit
  sleep 1
  '''
 }


 stage("Upload") {
  sh '''
  echo Uploading...
  sleep 1
  '''
 }

 stage("Email") {
   def subject = ""
   def bodyText = ""
   if (currentBuild.currentResult == 'SUCCESS') {
   subject = "Released $tag in $repo_slug"
   bodyText = """
    Hi there!!
    
    You pushed $tag in $clone_url and it is now released.
    Version $tag was built from $commit
    
    See job here: $BUILD_URL
    See log here: $BUILD_URL/consoleText
    """
   } else {
   subject = "Failed to release $tag in $repo_slug"
   bodyText = """
    Hi there!!
    
    You pushed $tag in $clone_url and the release failed (${currentBuild.currentResult}).
    
    See job here: $BUILD_URL
    See log here: $BUILD_URL/consoleText
    """
   }
   echo "Sending email with subject '$subject' and content:\n$bodyText"
   //emailext subject: subject
   // to: "$committer_email",
   // from: 'jenkins@company.com',
   // body: bodyText
 }

}